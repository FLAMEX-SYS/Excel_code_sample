Sub GeneratePivot()

    Dim wsData As Worksheet
    Dim wsPivot As Worksheet
    Dim PivotRange As Range
    Dim PivotTable As PivotTable
    Dim PivotTableName As String
    Dim LastCol As Long
    Dim LastRow As Long
    Dim NextCol As Long
    Dim ContinueCreating As VbMsgBoxResult
    Dim RowLabelTitle As String
    Dim ValueFieldName As String
    Dim NumResults As Integer

    ' Optimization
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    ' Reference to data sheet
    Set wsData = ThisWorkbook.Sheets("Data Sheet")

    ' Check if Pivot sheet exists, if not, create it
    On Error Resume Next
    Set wsPivot = ThisWorkbook.Sheets("Pivot")
    On Error GoTo 0
    If wsPivot Is Nothing Then
        Set wsPivot = ThisWorkbook.Sheets.Add
        wsPivot.Name = "Pivot"
    End If

    Do
        ' Determine the location for the next pivot table
        If wsPivot.PivotTables.Count = 0 Then
            NextCol = 1
        Else
            NextCol = wsPivot.Cells(1, Columns.Count).End(xlToLeft).Column + 3
        End If

        ' Define the data range for the pivot table
        LastCol = wsData.Cells(1, Columns.Count).End(xlToLeft).Column
        LastRow = wsData.Cells(Rows.Count, 1).End(xlUp).Row
        Set PivotRange = wsData.Range("A1:" & Cells(1, LastCol).Address).Resize(LastRow)

        ' Check if at least one value field is selected
        If Me.lstValues.ListIndex = -1 Then
            MsgBox "Please select at least one field for the VALUES area.", vbExclamation, "Selection Missing"
            Exit Sub
        End If

        ' Create a new pivot table
        PivotTableName = "PivotTable" & Format(Now, "ddmmyyhhmmss")
        Set PivotTable = wsPivot.PivotTables.Add(PivotCache:=ThisWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:=PivotRange), TableDestination:=wsPivot.Cells(1, NextCol), TableName:=PivotTableName)

        ' Add fields to the pivot table
        Dim i As Integer
        For i = 0 To Me.lstRows.ListCount - 1
            If Me.lstRows.Selected(i) Then PivotTable.AddDataField PivotTable.PivotFields(Me.lstRows.List(i)), "Count of " & Me.lstRows.List(i), xlCount
        Next i
        For i = 0 To Me.lstColumns.ListCount - 1
            If Me.lstColumns.Selected(i) Then PivotTable.PivotFields(Me.lstColumns.List(i)).Orientation = xlColumnField
        Next i
        For i = 0 To Me.lstValues.ListCount - 1
            If Me.lstValues.Selected(i) Then PivotTable.PivotFields(Me.lstValues.List(i)).Orientation = xlDataField
        Next i
        For i = 0 To Me.lstFilters.ListCount - 1
            If Me.lstFilters.Selected(i) Then PivotTable.PivotFields(Me.lstFilters.List(i)).Orientation = xlPageField
        Next i

        ' Determine primary value field and row label
        ValueFieldName = Me.lstValues.List(Me.lstValues.ListIndex)
        RowLabelTitle = PivotTable.RowFields(1).Name

        ' Sort the pivot table based on the count of the selected value field in descending order
        PivotTable.PivotFields(RowLabelTitle).AutoSort Order:=xlDescending, Field:="Count of " & ValueFieldName

        ' Ask the user for the number of top items they want to see
        On Error Resume Next
        NumResults = InputBox("Enter the number of top items you want to see:", "Top Items", 10)
        If NumResults <= 0 Then
            MsgBox "Please enter a positive number for top items.", vbExclamation, "Invalid Number"
            Exit Sub
        End If
        On Error GoTo 0

        ' Filter the pivot table to show only the top 'n' items based on the count
        PivotTable.PivotFields(RowLabelTitle).AutoShow Type:=xlAutomatic, Range:=xlTop, Count:=NumResults, Field:=PivotTable.DataFields("Count of " & ValueFieldName).Name

        ' Reset the list boxes for the next selection
        For i = 0 To Me.lstRows.ListCount - 1
            Me.lstRows.Selected(i) = False
        Next i
        For i = 0 To Me.lstColumns.ListCount - 1
            Me.lstColumns.Selected(i) = False
        Next i
        For i = 0 To Me.lstValues.ListCount - 1
            Me.lstValues.Selected(i) = False
        Next i
        For i = 0 To Me.lstFilters.ListCount - 1
            Me.lstFilters.Selected(i) = False
        Next i

        ' Ask the user if they want to continue creating new pivot tables
        ContinueCreating = MsgBox("Do you want to create another pivot table?", vbYesNo + vbQuestion, "Continue?")

    Loop Until ContinueCreating = vbNo

    ' Reset optimizations
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic

End Sub
